{% extends "base.html" %}

{% block title %}Job {{ job.id }}{% endblock %}

{% block content %}
<section class="card">
    <h2>Job {{ job.id }}</h2>
    <div class="details-grid">
        <div>
            <strong>Status</strong>
            <span class="status {{ job.status }}">{{ job.status }}</span>
        </div>
        <div>
            <strong>Started</strong>
            <span title="{{ job.started_at }}">{{ job.started_at_display }}</span>
        </div>
        <div>
            <strong>Finished</strong>
            <span {% if let Some(ts) = job.finished_at %}title="{{ ts }}"{% endif %}>{{ job.finished_at_display }}</span>
        </div>
        <div class="full">
            <strong>Playlist URL</strong>
            <span class="wrap">{{ job.playlist_url }}</span>
        </div>
        <div class="full">
            <strong>Command</strong>
            <code class="wrap">{{ job.command_line }}</code>
        </div>
        {% if let Some(err) = job.error.as_ref() %}
        <div class="full error">
            <strong>Last error</strong>
            <span>{{ err }}</span>
        </div>
        {% endif %}
    </div>
    {% if job.status.as_str() == "running" || job.status.as_str() == "pending" %}
    <form method="post" action="/jobs/{{ job.id }}/stop" class="stop-job-form" onsubmit="return confirm('Stop this job?');">
        <button type="submit" class="danger">Stop job</button>
    </form>
    {% endif %}
</section>

<section class="card">
    <h3>Logs</h3>
    <pre id="log-view">{{ job.log_text }}</pre>
</section>

<script>
const status = "{{ job.status }}";
if (status === "running" || status === "pending") {
    const logView = document.getElementById('log-view');
    async function refreshLogs() {
        try {
            const response = await fetch("/jobs/{{ job.id }}/log");
            if (response.ok) {
                logView.textContent = await response.text();
                logView.scrollTop = logView.scrollHeight;
            }
        } catch (err) {
            console.error(err);
        }
    }
    refreshLogs();
    setInterval(refreshLogs, 3000);
}
</script>
{% endblock %}
